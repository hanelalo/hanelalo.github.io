---
title: 软件架构-冷热数据分离
date: 2020-12-20 15:33:40
tags: 软件架构
catgegories: 软件架构
cover: http://image.hanelalo.cn/images/202111061339174.png
---
# 软件架构-冷热分离

## 什么是冷热分离？

在处理数据时，将数据分为冷库和热库，冷库的数据是那些已经走到终态的数据，热库是指那些还会做修改的数据。

## 冷热分离使用场景

* 数据走到终态之后，不会再有修改。因为这样不会再被修改的数据才能放入冷库。
* 站在用户使用场景的角度，支持新旧数据分开查询。

## 冷热分离思路

1. 如何判断数据是冷库数据还是热库数据？

   一般通过数据库中的某一个或者某一些字段组合来判断一条数据是否是冷数据。比如可能下单时间距今 3 个月的是冷数据，也可能下单时间距今 3 个月且状态为终态的才是冷数据，所以需要结合具体的业务场景，但是冷热数据的区分有必须注意的 2 点：

   * 一条数据一旦被标识为冷数据，就不能再对它有修改。
   * 在所有业务中，不会出现同时读取冷热数据的情况。

2. 什么时候进行冷热分离？

   触发冷热分离逻辑的方式一般有三种：

   a. 直接修改代码。每次修改数据时就出发冷热分离判断逻辑。

   优点：冷热数据实时分离，判断逻辑灵活可控。

   缺点：不能按照时间区分冷热；需要修改所有对数据库有改动的代码。

   b. 监听数据库 binlog 日志。

   优点：和业务代码解藕，虽然不算是实时，但是延迟也比较低。

   缺点：无法按照时间区分冷热数据；当出现业务代码和冷热分离代码同时处理同一数据时，需要考虑并发。

   c. 定时任务定时扫描。

   优点：与业务代码解藕，可以根据时间区分冷热数据。

   缺点：不能实时区分。

3. 如何实现冷热分离？

   a. 冷热数据判断。

   b. 插入冷库数据。

   c. 删除热库数据。

   但是还有需要注意的点是：

   * 一致性

     当搬运数据过程中任何一步出错，都得保证数据还是一致的。

     * 再热库中为待搬运的数据加上待搬运标识。
     * 找到有待搬运标识的数据。
     * 将上一步找到的数据保存到冷库，但是，为了保证当数据在冷库中已经存在时也可以顺利进行搬运，也就是保证幂等性，保存时需要加一个判断逻辑。
     * 从热库删除数据。

   * 数据量

     当数据量比较大时，可以使用批量处理的方式。

   * 并发

     当数据量达到每天单线程跑不完的情况，就可以考虑多线程。

4. 冷热数据的使用。

   在最开始就已经讲过，冷热数据不会出现同时使用的情况，所以，一般使用冷数据和热数据的查询页面都是分开的。

> 在使用冷热数据分离时，必须保证不会出现冷热数据同时使用的业务场景。